<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freeview PWA Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .pass { background: #e8f5e8; border-color: #4caf50; }
        .fail { background: #ffe8e8; border-color: #f44336; }
        .pending { background: #fff8e1; border-color: #ff9800; }
        .status { font-weight: bold; padding: 5px 10px; border-radius: 3px; margin-left: 10px; }
        .status.pass { background: #4caf50; color: white; }
        .status.fail { background: #f44336; color: white; }
        .status.pending { background: #ff9800; color: white; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .details { margin-top: 10px; font-size: 14px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Freeview PWA Compliance Test</h1>
    <p>This page helps verify that your PWA is properly configured.</p>

    <div id="tests">
        <!-- Tests will be dynamically added here -->
    </div>

    <div class="test-section">
        <h3>Manual Tests</h3>
        <p>After running the automated tests above, perform these manual checks:</p>
        <ol>
            <li><strong>Chrome DevTools:</strong> Open DevTools > Application > Manifest. Verify all fields are populated correctly.</li>
            <li><strong>Service Worker:</strong> In DevTools > Application > Service Workers, verify the worker is registered and active.</li>
            <li><strong>Installability:</strong> Look for the install prompt in your browser's address bar (usually a + or install icon).</li>
            <li><strong>Offline Test:</strong> Install the app, then disconnect from the internet and verify it still loads.</li>
            <li><strong>Lighthouse:</strong> Run a Lighthouse audit in DevTools for PWA compliance score.</li>
        </ol>
    </div>

    <script>
        const tests = [
            {
                name: "Service Worker Support",
                test: () => 'serviceWorker' in navigator,
                fix: "Service Workers are not supported in this browser. Use a modern browser."
            },
            {
                name: "Manifest File",
                test: async () => {
                    try {
                        const response = await fetch('/manifest.json');
                        return response.ok;
                    } catch (e) {
                        return false;
                    }
                },
                fix: "Manifest file not found. Ensure manifest.json exists in the root directory."
            },
            {
                name: "Manifest Link in HTML",
                test: () => document.querySelector('link[rel="manifest"]') !== null,
                fix: "Add <link rel=\"manifest\" href=\"manifest.json\"> to your HTML head."
            },
            {
                name: "Service Worker Registration",
                test: async () => {
                    if (!('serviceWorker' in navigator)) return false;
                    try {
                        const registration = await navigator.serviceWorker.getRegistration();
                        return registration !== undefined;
                    } catch (e) {
                        return false;
                    }
                },
                fix: "Service Worker is not registered. Check console for registration errors."
            },
            {
                name: "HTTPS or Localhost",
                test: () => location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1',
                fix: "PWAs require HTTPS in production. Use a local server or deploy to HTTPS for testing."
            },
            {
                name: "Viewport Meta Tag",
                test: () => document.querySelector('meta[name="viewport"]') !== null,
                fix: "Add <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"> to HTML head."
            },
            {
                name: "Theme Color",
                test: () => document.querySelector('meta[name="theme-color"]') !== null,
                fix: "Add <meta name=\"theme-color\" content=\"#333333\"> to HTML head."
            }
        ];

        async function runTest(test) {
            try {
                const result = await test.test();
                return result;
            } catch (e) {
                console.error(`Test "${test.name}" failed:`, e);
                return false;
            }
        }

        function createTestElement(test, status, details = "") {
            const div = document.createElement('div');
            div.className = `test-section ${status}`;
            
            const statusSpan = document.createElement('span');
            statusSpan.className = `status ${status}`;
            statusSpan.textContent = status.toUpperCase();

            div.innerHTML = `
                <h3>${test.name} ${statusSpan.outerHTML}</h3>
                <div class="details">
                    ${details}
                    ${status === 'fail' ? `<strong>Fix:</strong> ${test.fix}` : ''}
                </div>
            `;

            return div;
        }

        async function runAllTests() {
            const container = document.getElementById('tests');
            container.innerHTML = '<h2>Running Tests...</h2>';

            for (const test of tests) {
                const pendingEl = createTestElement(test, 'pending', 'Running...');
                container.appendChild(pendingEl);

                const result = await runTest(test);
                const status = result ? 'pass' : 'fail';
                const details = result ? 'Test passed successfully!' : 'Test failed.';
                
                const finalEl = createTestElement(test, status, details);
                container.replaceChild(finalEl, pendingEl);
            }

            // Add summary
            const passedTests = tests.filter((test, index) => 
                container.children[index + 1].classList.contains('pass')
            );
            
            const summary = document.createElement('div');
            summary.className = 'test-section';
            summary.innerHTML = `
                <h2>Test Summary</h2>
                <p><strong>${passedTests.length}/${tests.length}</strong> tests passed.</p>
                ${passedTests.length === tests.length ? 
                    '<p style="color: green;">üéâ Your PWA is properly configured!</p>' : 
                    '<p style="color: orange;">‚ö†Ô∏è Some tests failed. Check the fixes above.</p>'
                }
            `;
            container.insertBefore(summary, container.firstChild);
        }

        // Run tests when page loads
        window.addEventListener('load', runAllTests);

        // Add install prompt testing
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            const installSection = document.createElement('div');
            installSection.className = 'test-section pass';
            installSection.innerHTML = `
                <h3>Install Prompt Available <span class="status pass">READY</span></h3>
                <div class="details">
                    The browser detected this as an installable PWA!
                    <button onclick="installApp()" style="display: block; margin-top: 10px;">Install App</button>
                </div>
            `;
            document.getElementById('tests').appendChild(installSection);
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    console.log('User choice:', choiceResult);
                    deferredPrompt = null;
                });
            }
        }
    </script>
</body>
</html>